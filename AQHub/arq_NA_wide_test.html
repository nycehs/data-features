<!DOCTYPE html>

<head>

	<!--Arquero-->
	<script src="https://cdn.jsdelivr.net/npm/arquero@latest"></script>
	{{/*  <script src="js/arquero@latest"></script> // for offline testing  */}}

</head>

<body style="background-color:black;">

<script>

	var dt;
	var fullTable;
	var shortTable;
	/*  var locSelect = "No location";  */
	{{/*  locSelect = "Queensboro Bridge";  */}}
	locSelect = "Broadway/35th St";
	console.log(locSelect);

	// Loads the csv as an arquero table
	aq.loadCSV(

		"https://raw.githubusercontent.com/nychealth/realtime-air-quality/main/RT_flat.csv"
		// "data/RT_flat_NA.csv" // for offline testing

	).then(data => {

		dt = data;

		fullTable = dt.objects() // puts the data into fullTable to use. 
		shortTable = fullTable // creating an array we'll slice for time-selection
		
		var startAt = fullTable.length - 24; // get a starting point of most recent 24 hours
		avTable = fullTable.slice(startAt, fullTable.length) // slicing the table to most recent 24 hours
		
		console.log("avTable (after slicing):")
		console.table(avTable)
		 
		arqTable = aq.from(avTable)
		console.log("arqTable (after conversion to aq table):")
		arqTable.slice(-24,).print(24)

		// Count number of entries. Stop if there are <18 entries.
		// Else, average the entries

		// deriving a new column `new_col` for the parsed selected column. I want the parsed column to have the 
		//	selected column's name, so I'm creating a Map object which will rename "new_col" to the value of `locSelect`

		const new_col = new Map()

		new_col.set("new_col", locSelect)
		console.log("new_col:", new_col)

		// you can use an object that contains a variable name by enclosing the whole expression in back-ticks, then 
		//	using `${var}` to insert the value
		// described at https://uwdata.github.io/arquero/api/expressions#limitations

		arqTable = arqTable
			.derive({new_col: `d => aq.op.parse_float(d['${locSelect}'])`})
			.rename(new_col)
		
		console.log("arqTable (after parse_float and rename):")
		arqTable.slice(-24,).print(Infinity)
		
		valid_vals = aq.agg(arqTable, aq.op.valid(locSelect))
		console.log("valid_vals", valid_vals)
		
		if (valid_vals >= 18) {

			avg_24 = aq.agg(arqTable, aq.op.mean(locSelect))

		} else {

			avg_24 = null

		};
		console.log("avg_24", avg_24)

	});
	
</script>

</body>
